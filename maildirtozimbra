#!/bin/bash

zmcmd="/opt/zimbra/bin/zmmailbox"
path='/export8/mdir/1/5/mlopez@manquehue.net/Maildir'
user=`echo $path |cut -d / -f6`
userfolder="/var/tmp/$user.folder"

#echo user
#find . -maxdepth 10 -type d -name cur | awk '{ print length($0),$0 | "sort -n"}' |awk '{print $2}'  |egrep -v '_' | sed '/^\s*$/d'  |awk -F '/' {'print $2'} |sed 's/^.//g' | while read line;
#find . -maxdepth 10 -type d -name cur | awk '{ print length($0),$0 | "sort -n"}' |awk '{print $2}'  |egrep -v '_' | sed '/^\s*$/d'  |awk -F '/' {'print $2'} |sed 's/^.//g' | sed 's/\./\//g' | while read line;
find . -maxdepth 10 -type d -name cur | awk '{ print length($0),$0 | "sort -n"}' |awk '{print $2}'  |egrep -v '_' | sed '/^\s*$/d'  |awk -F '/' {'print $2'} | sed 's/\./\//g' | while read line;
# echo $line
do
 	if [ "$line" != "/Sent" ] &&  [ "$line" != "/Spam" ] && [ "$line" != "/Drafts" ] && [ "$line" != "/Junk" ] && [ "$line" != "/Trash" ] && [ "$line" != "cur" ] 
	then
	    echo "cf $line" >> $userfolder
	    ##echo "cf" > /tmp/borra 
        fi
done
	#Creando carpetas
	echo "Creating folder"
	$zmcmd -z -m $user < $userfolder

##Sincronizando Inbox
echo "Transferring Inbox messages...." 
for msg in `ls $path'/'cur/ |sort `
  do 
    echo "addMessage "/Inbox" "$path'/cur/'$msg" " >> /var/tmp/$user"_mail_"Inbox
 done 
# #cargamos los correos del subdirectorio al zimbra
#  $zmcmd -z -m $user < /var/tmp/$user"_mail_"Inbox
  echo "Finished transferring Inbox messages...."
###Fin sincroniza Inbox

#Migrando data de directorios creados
while read line
do
 folder=`echo $line|cut -d " " -f2 | sed 's/^\///'g | sed 's/\//./g' `
 echo $folder
 ##Sincronizando carpetas
 for msg in `ls $path/.$folder'/'cur` 
   do
     if [[ "$folder" != *"."* ]]
     then
        echo "addMessage "$folder" "$path/.$folder/cur/$msg" " >> /var/tmp/$user"_mail_"$folder
        echo "Finished transferring messages from directories...."
     else
 	folderz=`echo $line| awk {'print $2'} |sed 's/\./\//g'`     
        echo $folderz
        echo "addMessage "$folderz" "$path/.$folder/cur/$msg" " >> /var/tmp/$user"_mail_"$folder
     fi
   done
done < $userfolder
